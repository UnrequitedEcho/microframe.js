class Microframe{constructor(e,t){this.targetElement=e,this.options=t}open(){document.body.style.height="100%",document.body.style.overflow="hidden",this.microframe=document.createElement("div"),this.microframe.id="microframe",this.panel=Microframe.createPanel(this.targetElement,this.options.showLegend),this.panel.classList.add("center"),this.microframe.appendChild(this.panel),this.onKeyDownBound=this.onKeyDown.bind(this),this.onClickBound=this.close.bind(this),document.addEventListener("keydown",this.onKeyDownBound),this.microframe.addEventListener("click",this.onClickBound),document.body.appendChild(this.microframe),this.microframe.getBoundingClientRect(),this.microframe.classList.add("show")}close(){document.removeEventListener("keydown",this.onKeyDownBound),this.microframe.classList.remove("show"),this.microframe.addEventListener("transitionend",()=>{this.microframe.remove()},{once:!0}),document.body.style.height="",document.body.style.overflow=""}onKeyDown(e){switch(e.key){case"Escape":e.preventDefault(),this.close();break;case"Tab":case"ArrowLeft":case"ArrowRight":case"ArrowUp":case"ArrowDown":e.preventDefault()}}static createPanel(e=null,t="all"){const s=document.createElement("div");if(s.className="panel",!e)return s;const i=e.cloneNode(!0),n=i.tagName.toLowerCase();if("img"!==n&&"video"!==n)return s.appendChild(i),s;if("img"===n?(i.sizes="100vw",i.decoding="async",i.loading="eager"):"video"===n&&(i.controls=!0,i.pause?.()),s.appendChild(i),"none"===t)return s;const r="image"===t&&"img"!==n||"video"===t&&"video"!==n?null:(i.alt||i.title)?.trim()||null;if(r){const e=document.createElement("div");e.className="legend",e.textContent=r,s.appendChild(e)}return s}}class MicroframeGallery extends Microframe{constructor(e,t){super(e,t);const s=this.targetElement.closest(".gallery, .media-group");this.galleryElements=Array.from(s.querySelectorAll("img, video, .microframe")),this.currentIndex=this.galleryElements.indexOf(this.targetElement)}open(){super.open();const e=e=>e>=0&&e<this.galleryElements.length?MicroframeGallery.createPanel(this.galleryElements[e],this.options.showLegend):MicroframeGallery.createPanel();this.displayPanels=[e(this.currentIndex-1),this.panel,e(this.currentIndex+1)],this.applyPanelClasses(),this.microframe.appendChild(this.displayPanels[2]),this.microframe.appendChild(this.displayPanels[0]),this.initNavHint(),this.initCounter(),this.onTouchStartBound=this.onTouchStart.bind(this),this.onTouchEndBound=this.onTouchEnd.bind(this),this.microframe.addEventListener("touchstart",this.onTouchStartBound),this.microframe.addEventListener("touchend",this.onTouchEndBound)}initNavHint(){if(!this.options.showNavHint)return;this.hint=document.createElement("div"),this.hint.className="nav-hint";const e=window.matchMedia("(hover: none) and (pointer: coarse)").matches?"Swipe left/right to navigate":"Use ← / → to navigate";this.hint.textContent=e,this.microframe.appendChild(this.hint),requestAnimationFrame(()=>this.hint.classList.add("show")),setTimeout(()=>this.hint.classList.remove("show"),5e3)}initCounter(){this.options.showCounter&&(this.counter=document.createElement("div"),this.counter.className="counter",this.counter.textContent=`${this.currentIndex+1}/${this.galleryElements.length}`,this.microframe.appendChild(this.counter),requestAnimationFrame(()=>this.counter.classList.add("show")))}onKeyDown(e){super.onKeyDown(e),"ArrowRight"===e.key&&this.shiftGallery(1),"ArrowLeft"===e.key&&this.shiftGallery(-1)}onTouchStart(e){const t=e.touches[0];this.touchStartX=t.clientX,this.touchStartY=t.clientY}onTouchEnd(e){const t=e.changedTouches[0],s=t.clientX-this.touchStartX,i=t.clientY-this.touchStartY;Math.abs(s)>Math.abs(i)&&Math.abs(s)>50&&(s<0?this.shiftGallery(1):this.shiftGallery(-1))}applyPanelClasses(){const e=["staging-left","center","staging-right"];this.displayPanels.forEach((t,s)=>{t&&(t.classList.remove("staging-left","center","staging-right"),t.classList.add(e[s]))})}shiftGallery(e){const t=this.currentIndex+e;if(t<0||t>=this.galleryElements.length)return;this.currentIndex=t,this.displayPanels[1].querySelectorAll("video").forEach(e=>{e.pause()});const s=e=>{e.style.opacity="0",this.microframe.appendChild(e),e.style.opacity=""};1===e?(this.displayPanels.shift()?.remove(),this.displayPanels.push(this.galleryElements[this.currentIndex+1]?MicroframeGallery.createPanel(this.galleryElements[this.currentIndex+1],this.options.showLegend):MicroframeGallery.createPanel()),s(this.displayPanels[2])):(this.displayPanels.pop()?.remove(),this.displayPanels.unshift(this.galleryElements[this.currentIndex-1]?MicroframeGallery.createPanel(this.galleryElements[this.currentIndex-1],this.options.showLegend):MicroframeGallery.createPanel()),s(this.displayPanels[0])),this.applyPanelClasses(),this.hint&&this.hint.classList.remove("show"),this.counter.textContent=`${this.currentIndex+1}/${this.galleryElements.length}`}}export function initMicroframe(e={}){const t={selector:"img, video, .microframe",ignoreClass:"no-microframe",gallerySelector:".gallery, .media-group",showNavHint:!0,showCounter:!0,showLegend:"all",...e};document.addEventListener("click",function(e){if(document.getElementById("microframe"))return;const s=e.target.closest(t.selector);if(s&&!s.classList.contains(t.ignoreClass)){let i;e.preventDefault(),i=s.closest(t.gallerySelector)?new MicroframeGallery(s,t):new Microframe(s,t),i.open()}})}